@model inmobiliariaBD.Models.ContratoDetalleViewModel
@{
    ViewData["Title"] = "Detalle de Contrato";
    var pagos = ViewBag.Pagos as List<inmobiliariaBD.Models.Pago>;
    var multas = ViewBag.Multas as List<inmobiliariaBD.Models.Multa>;
}

@if (TempData["Mensaje"] != null)
{
    <div class="alert text-white bg-opacity-75 border-start border-4 border-info shadow-sm px-4 py-3 rounded-3 mb-4"
        style="background-color: #1e2a38;">
        <i class="fa-solid fa-circle-info me-2 text-info"></i>
        <span class="fw-semibold text-info">Info:</span> @TempData["Mensaje"]
    </div>
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="text-light mb-0">üìÑ Detalle del Contrato</h2>

    <div class="d-flex flex-wrap gap-2">
        @if (Model.Contrato.Estado == "Vigente" && User.IsInRole("Admin"))
        {
            <button type="button" class="btn btn-sm btn-outline-danger ms-2" data-bs-toggle="modal"
                data-bs-target="#modalRescindir">
                <i class="fa-solid fa-ban"></i> Rescindir contrato
            </button>

        }


        <a asp-action="CreateOrEdit" asp-controller="Contrato" asp-route-esRenovacion="true"
            asp-route-inquilinoId="@Model.Contrato.InquilinoId" asp-route-inmuebleId="@Model.Contrato.InmuebleId"
            asp-route-monto="@Model.Contrato.Monto" class="btn btn-sm btn-outline-success">
            <i class="fa-solid fa-rotate-right"></i> Renovar contrato
        </a>




        <a asp-action="Index" class="btn btn-sm btn-outline-secondary">
            <i class="fa-solid fa-arrow-left"></i> Volver Al Listado
        </a>
    </div>
</div>





<div class="card bg-dark text-white border-secondary mb-4">
    <div class="card-header bg-primary text-white">
        <i class="fa-solid fa-file-contract"></i> Informaci√≥n del Contrato
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6 mb-3">
                <dl class="row">
                    <dt class="col-sm-4">N¬∞</dt>
                    <dd class="col-sm-8">@Model.Contrato.Id</dd>

                    <dt class="col-sm-4">Monto</dt>
                    <dd class="col-sm-8">$ @Model.Contrato.Monto</dd>

                    <dt class="col-sm-4">Desde</dt>
                    <dd class="col-sm-8">@Model.Contrato.Desde.ToString("dd/MM/yyyy")</dd>

                    <dt class="col-sm-4">Hasta</dt>
                    <dd class="col-sm-8">@Model.Contrato.Hasta.ToString("dd/MM/yyyy")</dd>
                </dl>
            </div>

            <div class="col-md-6 mb-3">
                <dl class="row">
                    <dt class="col-sm-4">Inquilino</dt>
                    <dd class="col-sm-8 d-flex align-items-center gap-2">
                        @($"{Model.Contrato.Inquilino.Persona.Nombre} {Model.Contrato.Inquilino.Persona.Apellido}")
                        <a asp-controller="Inquilino" asp-action="Detalles" asp-route-id="@Model.Contrato.InquilinoId"
                            class="btn btn-sm btn-outline-info">
                            <i class="fa-solid fa-eye"></i>
                        </a>
                    </dd>

                    <dt class="col-sm-4">Inmueble</dt>
                    <dd class="col-sm-8 d-flex align-items-center gap-2">
                        @($"{Model.Contrato.Inmueble.Direccion} ({Model.Contrato.Inmueble.Localidad})")
                        <a asp-controller="Inmueble" asp-action="Detalles" asp-route-id="@Model.Contrato.InmuebleId"
                            class="btn btn-sm btn-outline-info">
                            <i class="fa-solid fa-eye"></i>
                        </a>
                    </dd>


                    <dt class="col-sm-4">Estado</dt>
                    <dd class="col-sm-8">
                        <span
                            class="badge @(Model.Contrato.Estado == "Vigente" ? "bg-success" : Model.Contrato.Estado == "Finalizado" ? "bg-secondary" : "bg-danger") px-3 py-2">
                            @Model.Contrato.Estado
                        </span>
                    </dd>

                </dl>
            </div>
        </div>
    </div>
</div>

<h4 class="text-light mb-3">
    üí∞ Pagos realizados
    <a asp-controller="Pago" asp-action="CreateOrEdit" asp-route-contratoId="@Model.Contrato.Id"
        class="btn btn-sm btn-outline-success ms-3">
        <i class="fa-solid fa-plus"></i> Registrar nuevo pago
    </a>

</h4>




@if (pagos != null && pagos.Any())
{
    <div class="table-responsive">
        <table class="table table-dark table-bordered table-hover tabla-index">
            <thead class="bg-secondary text-light">
                <tr>
                    <th>ID</th>
                    <th>N¬∞ Pago</th>
                    <th>Monto</th>
                    <th>Fecha</th>
                    <th>Detalle</th>
                    <th>Tipo</th>
                    <th>Estado</th>
                    <th>Acciones</th>

                </tr>
            </thead>
            <tbody>
                @foreach (var pago in pagos)
                {
                    <tr>
                        <td>@pago.Id</td>
                        <td>@pago.NumeroPago</td>
                        <td>$ @pago.Monto</td>
                        <td>@pago.Fecha.ToString("dd/MM/yyyy")</td>
                        <td>@pago.Detalle</td>
                        <td>@pago.Tipo</td>
                        <td>
                            <span
                                class="badge @(pago.Estado == "Pago" ? "bg-success" : pago.Estado == "Pendiente" ? "bg-warning text-dark" : "bg-secondary")">
                                @(pago.Estado == "Pago" ? "Pagado" : pago.Estado == "Pendiente" ? "Pendiente" : "Anulado")
                            </span>
                        </td>
                        <td class="text-nowrap">
                            <a asp-controller="Pago" asp-action="Detalles" asp-route-id="@pago.Id"
                                asp-route-volverAContrato="true" class="btn btn-sm btn-outline-info me-1">
                                <i class="fa-solid fa-eye"></i>
                            </a>
                            <a asp-controller="Pago" asp-action="CreateOrEdit" asp-route-id="@pago.Id"
                                asp-route-contratoId="@Model.Contrato.Id" class="btn btn-sm btn-outline-warning me-1">
                                <i class="fa-solid fa-pen"></i>
                            </a>

                            @if (User.IsInRole("Admin"))
                            {
                                <button type="button" class="btn btn-sm btn-outline-danger" data-bs-toggle="modal"
                                    data-bs-target="#confirmModal" data-id="@pago.Id" data-contrato="@pago.ContratoId"
                                    data-inquilino="@($"{Model.Contrato.Inquilino.Persona.Nombre} {Model.Contrato.Inquilino.Persona.Apellido}")"
                                    data-numero="@pago.NumeroPago" data-monto="@pago.Monto"
                                    data-fecha="@pago.Fecha.ToString("dd/MM/yyyy")" data-tipo="Pago">
                                    <i class="fa-solid fa-trash"></i>
                                </button>

                            }

                        </td>

                    </tr>
                }
            </tbody>
        </table>
    </div>
}
else
{
    <div class="alert alert-info text-dark">Este contrato no tiene pagos registrados.</div>
}
<h4 class="text-light mb-3">
    ‚ö†Ô∏è Multas registradas
    <a asp-controller="Multa" asp-action="CreateOrEdit" asp-route-contratoId="@Model.Contrato.Id"
        class="btn btn-sm btn-outline-danger ms-3">
        <i class="fa-solid fa-plus"></i> Registrar nueva multa
    </a>
</h4>

@if (multas != null && multas.Any())
{
    <div class="table-responsive">
        <table class="table table-dark table-bordered table-hover tabla-index">
            <thead class="bg-secondary text-light">
                <tr>
                    <th>ID</th>
                    <th>Fecha Aviso</th>
                    <th>Fecha Terminaci√≥n</th>
                    <th>Monto</th>
                    <th>Acciones</th>

                </tr>
            </thead>
            <tbody>
                @foreach (var multa in multas)
                {
                    <tr>
                        <td>@multa.Id</td>
                        <td>@multa.FechaAviso.ToString("dd/MM/yyyy")</td>
                        <td>@multa.FechaTerminacion.ToString("dd/MM/yyyy")</td>
                        <td>$ @multa.Monto</td>
                        <td class="text-nowrap">
                            <a asp-controller="Multa" asp-action="Detalles" asp-route-id="@multa.Id"
                                asp-route-volverAContrato="true" class="btn btn-sm btn-outline-info me-1">
                                <i class="fa-solid fa-eye"></i>
                            </a>
                            <a asp-controller="Multa" asp-action="CreateOrEdit" asp-route-id="@multa.Id"
                                asp-route-contratoId="@Model.Contrato.Id" class="btn btn-sm btn-outline-warning me-1">
                                <i class="fa-solid fa-pen"></i>
                            </a>

                            @if (User.IsInRole("Admin"))
                            {
                                <button type="button" class="btn btn-sm btn-outline-danger" data-bs-toggle="modal"
                                    data-bs-target="#confirmModal" data-id="@multa.Id" data-contrato="@multa.ContratoId"
                                    data-inquilino="@($"{Model.Contrato.Inquilino.Persona.Nombre} {Model.Contrato.Inquilino.Persona.Apellido}")"
                                    data-numero="‚Äî" data-monto="@multa.Monto" data-fecha="@multa.FechaAviso.ToString("dd/MM/yyyy")"
                                    data-tipo="Multa">
                                    <i class="fa-solid fa-trash"></i>
                                </button>

                            }


                        </td>

                    </tr>
                }
            </tbody>
        </table>
    </div>
}
else
{
    <div class="alert alert-info text-dark">Este contrato no tiene multas registradas.</div>
}

@if (User.IsInRole("Admin") && Model.Auditoria?.Any() == true)
{
    <h4 class="text-light mt-5 mb-3">
        <i class="fa-solid fa-user-secret"></i> Auditor√≠a del contrato
    </h4>

    <div class="table-responsive">
        <table class="table table-dark table-bordered table-hover tabla-index">
            <thead class="bg-gradient bg-secondary text-light text-center">
                <tr>
                    <th style="width: 25%">Acci√≥n realizada</th>
                    <th style="width: 35%">Usuario responsable</th>
                    <th style="width: 15%">DNI</th>
                    <th style="width: 20%">Fecha</th>
                    <th style="width: 20%">Hora</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var log in Model.Auditoria.OrderByDescending(l => l.Fecha))
                {
                    <tr>
                        <td>@log.Accion</td>
                        <td>@($"{log.Usuario.Persona.Nombre} {log.Usuario.Persona.Apellido}")</td>
                        <td>@log.Usuario.Persona.Dni</td>
                        <td>@log.Fecha.ToString("dd/MM/yyyy")</td>
                        <td>@log.Fecha.ToString("HH:mm:ss")</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}
else if (User.IsInRole("Admin"))
{
    <div class="alert alert-warning mt-4">
        <i class="fa-solid fa-circle-info"></i> No hay registros de auditor√≠a para este contrato.
    </div>
}




@*-----------------------------------------------MODAL ELIMINAR PAGO o CONTRATO---------------------------------------------*@
<div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-white border-secondary">
            <form id="modal-form" method="post">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="modalLabel">Confirmar eliminaci√≥n</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <p>¬øEst√°s seguro que quer√©s eliminar el siguiente <strong><span id="modal-tipo"></span></strong>?
                    </p>
                    <ul class="list-unstyled">
                        <li><strong>Registro N¬∞:</strong> <span id="modal-id"></span></li>
                        <li><strong>Contrato N¬∞:</strong> <span id="modal-contrato"></span></li>
                        <li><strong>Inquilino:</strong> <span id="modal-inquilino"></span></li>
                        <li><strong>N¬∞ de Pago:</strong> <span id="modal-numero"></span></li>
                        <li><strong>Monto:</strong> $<span id="modal-monto"></span></li>
                        <li><strong>Fecha:</strong> <span id="modal-fecha"></span></li>
                    </ul>
                    <input type="hidden" name="id" id="form-id" />
                    <input type="hidden" name="volverAContrato" value="true" />

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-outline-danger">Confirmar eliminaci√≥n</button>
                </div>
            </form>
        </div>
    </div>
</div>

@*------------------------------------------------MODAL RECINDIR--------------------------------------------------------*@
<div class="modal fade" id="modalRescindir" tabindex="-1" aria-labelledby="modalRescindirLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-white border-danger">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="modalRescindirLabel">Confirmar rescisi√≥n</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <p>¬øEst√°s seguro que quer√©s <strong>rescindir este contrato</strong>?</p>
                <div class="alert alert-danger text-dark mt-3">
                    <i class="fa-solid fa-triangle-exclamation me-2"></i>
                    Al confirmar, se generar√° autom√°ticamente una <strong>multa por rescisi√≥n anticipada</strong>.
                </div>
            </div>
            <div class="modal-footer">
                <form asp-action="ModificarEstado" asp-controller="Contrato" method="post">
                    <input type="hidden" name="id" value="@Model.Contrato.Id" />
                    <input type="hidden" name="nuevoEstado" value="Rescindido" />
                    <button type="submit" class="btn btn-outline-danger">Confirmar rescisi√≥n</button>
                </form>
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
            </div>
        </div>
    </div>
</div>



@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const confirmModal = document.getElementById('confirmModal');
            const modalForm = document.getElementById('modal-form');

            confirmModal.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget;
                const tipo = button.getAttribute('data-tipo');
                const id = button.getAttribute('data-id');
                const contrato = button.getAttribute('data-contrato');
                const inquilino = button.getAttribute('data-inquilino');
                const numero = button.getAttribute('data-numero');
                const monto = button.getAttribute('data-monto');
                const fecha = button.getAttribute('data-fecha');

                document.getElementById('modal-tipo').textContent = tipo;
                document.getElementById('modal-id').textContent = id;
                document.getElementById('modal-contrato').textContent = contrato;
                document.getElementById('modal-inquilino').textContent = inquilino;
                document.getElementById('modal-numero').textContent = numero;
                document.getElementById('modal-monto').textContent = monto;
                document.getElementById('modal-fecha').textContent = fecha;
                document.getElementById('form-id').value = id;

                // Set form action dynamically
                modalForm.action = tipo === "Pago"
                    ? `/Pago/Baja`
                    : `/Multa/Baja`;
            });
        });
    </script>
}